<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mixvlmc">
<title>Implementation Notes • mixvlmc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Implementation Notes">
<meta property="og:description" content="mixvlmc">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mixvlmc</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Getting started</h6>
    <a class="dropdown-item" href="../articles/context-trees.html">Context trees</a>
    <a class="dropdown-item" href="../articles/variable-length-markov-chains.html">Variable length Markov chains (VLMC)</a>
    <a class="dropdown-item" href="../articles/covlmc.html">Variable Length Markov Chains with Covariates (COVLMC)</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Advanced topics</h6>
    <a class="dropdown-item" href="../articles/likelihood.html">Likelihood calculation</a>
    <a class="dropdown-item" href="../articles/prediction.html">Predicting with (CO)VLMC</a>
    <a class="dropdown-item" href="../articles/sampling.html">Sampling from (CO)VLMC</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://fabrice-rossi.github.io/blog/posts/mixvlmc-0-2.html">mixvlmc 0.2.0</a>
    <a class="external-link dropdown-item" href="https://fabrice-rossi.github.io/blog/posts/mixvlmc-0-1.html">mixvlmc 0.1.1</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/fabrice-rossi/mixvlmc/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Implementation Notes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fabrice-rossi/mixvlmc/blob/HEAD/vignettes/articles/implementation.Rmd" class="external-link"><code>vignettes/articles/implementation.Rmd</code></a></small>
      <div class="d-none name"><code>implementation.Rmd</code></div>
    </div>

    
    
<p>This document contains some implementation notes for the
<code>mixvlmc</code> package.</p>
<div class="section level2">
<h2 id="r-backend">R backend<a class="anchor" aria-label="anchor" href="#r-backend"></a>
</h2>
<div class="section level3">
<h3 id="representation">Representation<a class="anchor" aria-label="anchor" href="#representation"></a>
</h3>
<div class="section level4">
<h4 id="context-trees">Context trees<a class="anchor" aria-label="anchor" href="#context-trees"></a>
</h4>
<p>The R backend uses a pure R representation of context trees based on
nested lists. A context tree is essentially a root node represented by a
list of class <code>ctx_tree</code> with at least a <code>vals</code>
component that contains the values allowed in the state space of the
context tree (accessed via the <code><a href="../reference/states.html">states()</a></code> function). It
contains the following additional components:</p>
<ul>
<li>
<code>keep_match</code>: equals to the value of
<code>keep_position</code> in the call to <code><a href="../reference/ctx_tree.html">ctx_tree()</a></code>;</li>
<li>
<code>data_size</code>: the length of the time series used to build
the context tree.</li>
</ul>
<p>In general, the list contains also two additional components used to
speed up basic operations:</p>
<ul>
<li>
<code>depth</code>: the depth of the context tree, i.e. its longest
context (accessed via the <code><a href="../reference/depth.html">depth()</a></code> function);</li>
<li>
<code>nb_ctx</code>: the number of proper contexts represented in
the context tree (accessed via the <code>contexts_numbers()</code>
function).</li>
</ul>
<p>When the context tree is not empty, its list contains a
<code>children</code> component that contains the first level nodes of
the tree. Each node (including the root) is a list with the following
components:</p>
<ul>
<li>
<code>f_by</code> is an integer vector which counts how many time
the context represented by the node if followed by each of the possible
state in the time series (see <code><a href="../reference/counts.html">counts()</a></code> for a context node
based access to this);</li>
<li>
<code>match</code> records the position of the contexts in the time
series: this is optional and depends on parameters used during the
construction of the tree. The positions are recorded as returned from an
internal C++ search function and must be modified to be interpreted as
actual positions in the time series: if the context is of length
<code>d</code> then <code>match + d</code> is the positions at which the
context ends in the time series (as in the <code><a href="../reference/positions.html">positions()</a></code>
function);</li>
<li>
<code>children</code> lists the children of the node if it is not a
leaf.</li>
</ul>
<p>The root not does not have a <code>match</code> attributes as it
corresponds to the empty context which matches every position in the
time series. Notice that while a node does not always represent a proper
context, it is still a subsequence that appears in the time series. Thus
<code>f_by</code> is always present, as well as is <code>match</code>
when positions are kept.</p>
<p>The root node contains additional components that are useful for the
VLMC implementation and thus described below.</p>
</div>
<div class="section level4">
<h4 id="vlmc">VLMC<a class="anchor" aria-label="anchor" href="#vlmc"></a>
</h4>
<p>VLMC are represented with context trees. The represented is only
enriched with some additional components for the root node, most
notably:</p>
<ul>
<li>
<code>alpha</code>: the cut off parameter in quantile scale;</li>
<li>
<code>cutoff</code>: the cut off parameter in native scale;</li>
<li>
<code>pruned</code>: whether the VLMC was actually pruned based on
the cut off parameter.</li>
</ul>
<p>The first two components are always present whether or not the VLMC
was pruned. In addition, while only one scale is used in the call to
<code><a href="../reference/vlmc.html">vlmc()</a></code> both scales are present (and consistent).</p>
<p>To speed up the likelihood calculation, a context tree contains in
its root a copy of the first few observations in the original time
series, up to the depth of tree. It is saved in the <code>ix</code>
component. Additionally, a VLMC contains a component
<code>extended_ll</code> which records the log likelihood of the model
for the first <code>depth</code> observations computed using the
extended likelihood function (see
<code><a href="../articles/likelihood.html">vignette("likelihood")</a></code>).</p>
</div>
</div>
<div class="section level3">
<h3 id="likelihood-calculation">Likelihood calculation<a class="anchor" aria-label="anchor" href="#likelihood-calculation"></a>
</h3>
<p>Likelihood functions for VLMC are not implemented in the most natural
way. A natural approach would be to iterate through a time series, find
the context applicable at each time point, compute the probability of
observing the actual value in this context and aggregate the
probabilities.</p>
<p>In practice, it is frequently faster to use the same C++ matching
function used during the construction of the context tree to build a
sort of instance tree. This is done via the internal function
<code>match_ctx</code>. This function adds to each node of a context
tree a new component <code>data_f_by</code> which counts how many times
the sub-sequence represented by a node is followed by each element of
the state space in an arbitrary time series (while <code>f_by</code>
does that for the original time series).</p>
<p>The log likelihood functions are then implemented by the internal
<code>rec_loglikelihood_vlmc</code> function. It descends recursively in
the modified VLMC tree and used both <code>f_by</code> and
<code>data_f_by</code> to compute likelihoods.</p>
</div>
</div>
<div class="section level2">
<h2 id="c-backend">C++ backend<a class="anchor" aria-label="anchor" href="#c-backend"></a>
</h2>
<div class="section level3">
<h3 id="suffix-tree">Suffix tree<a class="anchor" aria-label="anchor" href="#suffix-tree"></a>
</h3>
<p>The package uses suffix trees to build efficiently context trees.
Suffix trees are constructed from the integer representation of the
discrete time series, assuming that they contain only non negative
integers. As a consequence, negative values can be used as
sentinels.</p>
<p>Following <a href="https://dx.doi.org/10.1109/TIT.2006.881742" class="external-link">Garivier’s paper</a>
we build the suffix tree of the reverse sequence (in other words the
prefix tree).</p>
<div class="section level4">
<h4 id="representation-1">Representation<a class="anchor" aria-label="anchor" href="#representation-1"></a>
</h4>
<p>The suffix tree is represented by a main C++ class
<code>SuffixTree</code> which uses <code>EdgeNode</code> objects
internally. As indicated by the name, an <code>EdgeNode</code>
represents both a node in the suffix tree and the edge used to reach it
from another node.</p>
<p>An <code>EdgeNode</code> contains:</p>
<ul>
<li>a compact representation of the subsequence that labels its edge
using <code>start</code> and <code>end</code> as the position of this
subsequence in the main one. <code>start</code> is included in the
subsequence <code>end</code> is not. During the construction of the
suffix tree <code>end</code> can be set to <code>n+1</code> where
<code>n</code> is the length of the main sequence. This is the classical
trick used to represent open ended edges;</li>
<li>a dictionary of its <code>children</code> (if any): this maps an
element of the sequence to (a pointer to) the corresponding child
<code>NodeEdge</code>;</li>
<li>a <code>suffix</code> pointer that represents a suffix link;</li>
<li>a <code>parent</code> pointer that points to the parent node (used
during node expansion);</li>
<li>a <code>counts</code> pointer to a map that maps values to the
number of times the subsequence represented by the current node (from
the root) is preceded by this value in the original sequence;</li>
<li>an integer <code>total_count</code> which gives the number of
occurrences of the subsequence when preceded by another value;</li>
<li>an integer <code>depth</code> that gives the length of the
subsequence represented by this node;</li>
<li>a <code>positions</code> pointer that points to a vector of
positions of the subsequence in the original sequence.</li>
</ul>
<p>Notice that only the <code>start</code>, <code>end</code>,
<code>suffix</code> and <code>parent</code> are set during the suffix
tree construction.</p>
</div>
<div class="section level4">
<h4 id="construction">Construction<a class="anchor" aria-label="anchor" href="#construction"></a>
</h4>
<p>The suffix tree is constructed using <a href="https://doi.org/10.1007%2FBF01206331" class="external-link">Ukkonen’s algorithm</a>.
More precisely, for a sequence <code>x</code>, we build the suffix tree
of <code>rev(x)[-1]</code>: the tree contains all the prefixes of
<code>x</code> without its last value. This guarantees that all
sub-sequences detected by the tree appeared followed by at least one
value, which makes them potential contexts. Notice that following a link
in the suffix tree corresponds to extending a context into the past
which is exactly what is needed for the practical use of the suffix tree
as a context tree.</p>
</div>
<div class="section level4">
<h4 id="counts">Counts<a class="anchor" aria-label="anchor" href="#counts"></a>
</h4>
<p>After the construction of the suffix tree, the
<code>compute_counts</code> method is used to compute the number of
occurrences of each subsequence represented by the suffix tree as well
as the distribution of the values that follow them in the original
sequence, as proposed in <a href="https://dx.doi.org/10.1109/TIT.2006.881742" class="external-link">Garivier’s paper</a>.
The method uses <code>rev(x)[1]</code>, that is the last value of
<code>x</code> to include this final value in the counts.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://fabrice-rossi.github.io/" class="external-link">Fabrice Rossi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
