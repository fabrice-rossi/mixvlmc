---
title: "Likelihood calculation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Likelihood calculation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mixvlmc)
library(geodist) ## used in the earth quake example
```

Most of the theoretical papers on Variable Length Markov Chains (VLMC, see `vignette("variable-length-markov-chains")`) focus on time series indexed by $\mathbb{Z}$ which simplifies the analysis. In practice time series are obviously finite which introduces some difficulties associated to the initial observations. In particular, the definition of a likelihood function is not entirely obvious.

## Likelihood functions for Markov chains

Let us consider a doubly infinite time series $X_{i\in\mathbb{Z}}$ generated by some model $\mathcal{M}$. The likelihood function associated to a finite observation of the time series, $(x_i)_{1\leq i\leq n}$, is $\mathbb{P}_{\mathcal{M}}(X_1=x_1,\ldots,X_n=x_n)$.

If $\mathcal{M}$ is a Markov chain of order $d$, then we have $$
\mathbb{P}_{\mathcal{M}}(X_{d+1}=x_{d+1},\ldots,X_n=x_n)=\prod_{i=d+1}^n\mathbb{P}_{\mathcal{M}}(X_i=x_i|X_{i-1}=x_{i-1},\ldots,X_{i-d}=x_{i-d}).
$$ Thus if we know only $x_{1\leq i\leq n}$ we can compute only the likelihood of $(x_i)_{d+1\leq i\leq n}$.

In practice, comparing models with different orders should be done only using the likelihood functions based on the same subset of the observed time series, i.e. using the highest order. As pointed out in several papers this has no impact on asymptotic results (see e.g. [Garivier, A. (2006), Consistency of the unlimited BIC context tree estimator. IEEE Transactions on Information Theory, 52 (10) 4630--4635](https://dx.doi.org/10.1109/TIT.2006.881742)).

## Likelihood functions for VLMC

### Truncated solution

The simplest way to define a likelihood function for a VLMC is to consider it as a Markov chain of the order given by the length of its longest context (i.e. of the order of the VLMC).

### Specific contexts

Another approach considers the fact that the past of $(x_i)_{1\leq i\leq n}$ is unknown and replace it by a collection of specific contexts that summarize this unknown past. This is used in Garivier's paper cited above. By definition, each observation that does not have a actual context in the VLMC appears only once and thus is perfectly predicted by the empirical distribution associated to it. It has therefore a likelihood of 1. In practice, this amounts to identifying $\mathbb{P}_{\mathcal{M}}(X_1=x_1,\ldots,X_n=x_n)$ to $\mathbb{P}_{\mathcal{M}}(X_{d+1}=x_{d+1},\ldots,X_n=x_n)$.

In terms of parameters for AIC/BIC calculation, this corresponds to adding a specific distribution for each of the $d$ initial values, where $d$ is the order of the VLMC.

### Extended contexts

Another approach considers extended/approximate contexts for the $d$ initial values. Indeed each observation $x_i$ for $1\leq i\leq d$ can be considered has having its context partially determined by $(x_1,\ldots, x_{i-1})$ (thus by the empty context for $i=1$). Let us consider for instance $x_1$ and the empty context (the root of the context tree). If $d\geq 1$, we cannot determine the context of $x_1$ without values of $(x_{-d+1},\ldots, x_0)$ even if the empty context is a valid one. However, we can assign this empty context to $x_1$ because of the lack of information. More generally, we can traverse the context tree using as many past values as available and stop in the corresponding node which is then interpreted as a context using the frequencies collected during the construction of the VLMC.

In terms of parameters, this adds to the VLMC an additional extended context for each node of the context tree which is not a context. 

## Complete example

Let us revisit the California earth quakes example proposed in `vignette("variable-length-markov-chains")`. The model is obtained as follows 
(see the vignette for details):
```{r}
California_centre <- data.frame(longitude = -119.449444, latitude = 37.166111)
distances <- geodist(globalearthquake[, c("longitude", "latitude")],
  California_centre,
  measure = "geodesic"
)
California_earth_quakes <- globalearthquake[distances < 2e6, ] ## distances are in meters
California_weeks <- rep(0, max(globalearthquake$nbweeks))
California_weeks[California_earth_quakes$nbweeks] <- 1
California_weeks_earth_quakes_model <- tune_vlmc(California_weeks)
model <- as_vlmc(California_weeks_earth_quakes_model)
draw(model, prob = FALSE)
```

The optimal model according to the BIC as an order of `r depth(model)` and thus
the simple truncated log likelihood is obtained by considering only the observations
starting at index 6. We disregard the first 5 observations, i.e.:
```{r}
California_weeks[1:5]
```
The corresponding log likelihood is
```{r}
loglikelihood(model)
```

Using specific contexts amounts to assuming perfect predictions for the first
five observations. The log likelihood is not modified, but it covers now the full
time series, i.e. `r length(California_weeks)` observations. The number of parameters
is increased significantly as each of the 5 initial values is associated to a full
conditional distribution leading to a total of `r (depth(model) + context_number(model))`
parameters.

```{r}
loglikelihood(model, initial = "specific")
```

The extended context approach is the most complex. For the first observation, 
we use the empty context, i.e. the root of the context tree. The associated
empirical distribution is $\mathbb{P}(X_1=1)=\frac{1291}{5126+1291}\simeq`r round(1291/(5126+1291),3)`$. 
Its contribution to the log likelihood is therefore 
$\log \mathbb{P}(X_1=0)\simeq `r round(log(5126/(5126+1291)),3)`$ as the first
observation is equal to `r California_weeks[1]`. 

As the root node is not a proper context, the specification of its associated 
empirical distribution contributes to the total number of parameters of the model 
(i.e. it adds a parameter to the total). 

For the second observation, $X_2=`r California_weeks[2]`$,  the candidate context
is $0$. However, $0$ is again not a proper context we should normally look for 
$X_{0}$ and older values to find a proper context. In the extended approach, we
consider the empirical distribution of values following a 0 in the time series, 
which is given by $\mathbb{P}(X_1=1)=\frac{940}{4185+940}\simeq`r round(940/(4185+940),3)`$.
The contribution of this observation to the log likelihood is therefore 
$\log \mathbb{P}(X_1=0)\simeq `r round(log(4185/(4185+940)),3)`$. In addition, this
extended context adds again a parameter to the total. 

The following observations $X_3$, $X_4$ and $X_5$ have all proper contexts and
contribute in a normal way to the (log) likelihood without the need for additional
parameters. Notice that the number of additional parameters does not depend on the
initial sequence but on the structure of the context tree. Notice also that while
the corresponding nodes are contexts, they are not the contexts of those three values.
Those contexts cannot be computed due to the lack of older values. 

The final value is
```{r}
loglikelihood(model, initial = "extended")
```

